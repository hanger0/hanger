<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="Data">
	<typeAlias alias="user" type="com.hanger.user.vo.UserVo"/>
	
	<select id="loginUser" parameterClass="user" resultClass="user">
		SELECT
			USER_NAME as userName, USER_CODE as userCode
		FROM
			USER
		WHERE
			USER_ID = #userId# AND USER_PWD = #userPwd# AND USER_USE_YN = 'Y'
	</select>
	
	<insert id="insertUser" parameterClass="user">
		INSERT INTO USER(USER_CODE, USER_ID, USER_PWD, USER_NAME, USER_GENDER, USER_BIRTH, USER_PHONE, USER_QUESTION, USER_ANSWER, USER_ADDR1, USER_ADDR2, USER_POSTCODE1, USER_POSTCODE2, USER_PIC_PATH, USER_PIC_ORG_NAME, USER_PIC_SAVE_NAME, USER_SKINTYPE, USER_SKINTONE, USER_SKINPROBLEM, REG_ID, REG_DATE, REG_IP, UPD_ID, UPD_DATE, UPD_IP)
		VALUES(CONCAT("UR",LPAD((SELECT GET_SEQ('USER_CODE')), 10, '0')), #userId#, #userPwd#, #userName#, #userGender#, #userBirth#, #userPhone#, #userQuestion#, #userAnswer#, #userAddr1#, #userAddr2#, #userPostCode1#, #userPostCode2#, #userPicPath#, #userPicOrgName#, #userPicSaveName#, #userSkinType#, #userSkinTone#, #userSkinProblem#, #regId#, sysdate(), #regIp#, #updId#, sysdate(), #updIp#)
	</insert>
	
	<update id="updateUser" parameterClass="user">
		update user set USER_PWD = #userPwd#, USER_NAME = #userName#, USER_PHONE = #userPhone#, USER_QUESTION = #userQuestion#, USER_ANSWER = #userAnswer#, USER_ADDR1 = #userAddr1#, USER_ADDR2 = #userAddr2#, USER_POSTCODE1 = #userPostCode1#, USER_POSTCODE2 = #userPostCode2#, USER_PIC_PATH = #userPicPath#, USER_PIC_ORG_NAME = #userPicOrgName#, USER_PIC_SAVE_NAME = #userPicSaveName#, USER_SKINTYPE = #userSkinType#, USER_SKINTONE = #userSkinTone#, USER_SKINPROBLEM = #userSkinProblem#, upd_id = #updId#, UPD_DATE = #updDate#, UPD_IP = #updIp#
		where USER_ID = #userId#
	</update>
	
	<update id="deleteUser" parameterClass="user">
		UPDATE USER SET USER_USE_YN = 'N' WHERE USER_ID = #userCode#
	</update>
	
	<select id="searchUser" parameterClass="HashMap" resultClass="user">
		SELECT 
			a.USER_NAME as userName, a.USER_ID as userId, a.USER_PHONE as userPhone, a.USER_PIC_PATH as userPicPath, a.USER_PIC_SAVE_NAME as userPicSaveName, 
			a.USER_CODE as userCode, a.USER_SKINTYPE as userSkinType, a.USER_SKINTONE as userSkinTone, a.USER_SKINPROBLEM as userSkinProblem, count(b.RELATION_FOLLOWING) as followerCount,
      		count(c.posting_code) as postingCount, G.RELATION_FOLLOWING as relationFollowing
		FROM 
			USER a left join relation b on a.USER_CODE = b.RELATION_FOLLOWER left join review c on a.USER_CODE = c.USER_CODE
      left join (SELECT relation_following FROM relation WHERE relation_follower = #myUserCode#)G on a.USER_CODE = G.RELATION_FOLLOWING
		WHERE 
			(a.USER_NAME LIKE '%$qt$%' OR a.USER_PHONE = #qt# OR a.USER_ID = #qt#) AND a.USER_USE_YN = 'Y' AND NOT a.USER_CODE = #myUserCode#
  		GROUP BY 
  			a.USER_NAME, a.USER_ID, a.USER_PHONE, a.USER_PIC_PATH, a.USER_PIC_SAVE_NAME,  
			a.USER_CODE, a.USER_SKINTYPE, a.USER_SKINTONE, a.USER_SKINPROBLEM
	</select>
	
	<select id="selectPassword" parameterClass="user">
		SELECT 
			USER_PWD 
		FROM 
			USER 
		WHERE 
			USER_ID = #userId# AND USER_ANSWER = #userAnswer# AND USER_QUESTION = #userQuestion# AND USER_USE_YN = 'Y'
	</select>
</sqlMap>
